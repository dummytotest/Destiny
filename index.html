<body>
   <div class="container">
      <div class="card__container" id="card-gallery"></div>
   </div>

   <button class="fab" onclick="toggleModal()">+</button>

   <div id="uploadModal" class="modal">
      <div class="modal-content">
         <span class="close" onclick="toggleModal()">&times;</span>
         <h3>Add a New Memory</h3>
         <input type="text" id="mem-title" placeholder="Title (e.g., Pyaarusaur)">
         <input type="text" id="mem-subtitle" placeholder="Subtitle (e.g., Flowers for me?)">
         <textarea id="mem-desc" placeholder="Write the memory here..."></textarea>
         <input type="file" id="mem-file" accept="image/*">
         <button id="upload-btn" onclick="handleUpload()">Upload to Destiny</button>
      </div>
   </div>

   <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import { getFirestore, collection, addDoc, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
      import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

      // PASTE YOUR FIREBASE CONFIG HERE
      const firebaseConfig = {
         apiKey: "YOUR_API_KEY",
         authDomain: "YOUR_PROJECT.firebaseapp.com",
         projectId: "YOUR_PROJECT_ID",
         storageBucket: "YOUR_PROJECT.appspot.com",
         messagingSenderId: "YOUR_ID",
         appId: "YOUR_APP_ID"
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const storage = getStorage(app);

      // EXPOSE FUNCTIONS TO WINDOW
      window.handleUpload = async () => {
         const file = document.getElementById('mem-file').files[0];
         const title = document.getElementById('mem-title').value;
         const sub = document.getElementById('mem-subtitle').value;
         const desc = document.getElementById('mem-desc').value;
         const btn = document.getElementById('upload-btn');

         if(!file || !title) return alert("Please add a photo and title!");

         btn.innerText = "Uploading...";
         btn.disabled = true;

         try {
            // 1. Upload Image
            const storageRef = ref(storage, 'memories/' + Date.now() + "_" + file.name);
            await uploadBytes(storageRef, file);
            const url = await getDownloadURL(storageRef);

            // 2. Save to Firestore
            await addDoc(collection(db, "memories"), {
               title, subtitle: sub, description: desc, imageUrl: url, createdAt: new Date()
            });

            toggleModal();
            btn.innerText = "Upload to Destiny";
            btn.disabled = false;
         } catch (e) {
            console.error(e);
            alert("Upload failed!");
         }
      };

      // 3. Listen for Data (Real-time)
      const q = query(collection(db, "memories"), orderBy("createdAt", "desc"));
      onSnapshot(q, (snapshot) => {
         const gallery = document.getElementById('card-gallery');
         gallery.innerHTML = ''; 
         snapshot.forEach(doc => {
            const data = doc.data();
            gallery.innerHTML += `
               <article class="card__article">
                  <img src="${data.imageUrl}" class="card__img">
                  <div class="card__data">
                     <span class="card__description">${data.subtitle}</span>
                     <h2 class="card__title">${data.title}</h2>
                     <h4>${data.description}</h4>
                  </div>
               </article>`;
         });
      });
   </script>
</body>
